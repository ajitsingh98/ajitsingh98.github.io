<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ '/assets/css/markdown-style.css' | relative_url }}">
    <title>{{ page.title }}</title>

    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                tags: 'ams',
                packages: { '[+]': ['ams'] }
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                renderActions: {
                    find_script: [10, function (doc) {
                        for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                            const display = !!node.type.match(/; *mode=display/);
                            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                            const text = document.createTextNode('');
                            node.parentNode.replaceChild(text, node);
                            math.start = { node: text, delim: '', n: 0 };
                            math.end = { node: text, delim: '', n: 0 };
                            doc.math.push(math);
                        }
                    }, '']
                }
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <!-- Load MathJax Script -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" async></script>
    
    <style>
        /* Center the first h2 header */
        h2:first-of-type {
            text-align: center;
        }

        /* Ensure proper rendering of LaTeX matrices */
        .mathjax-display {
            text-align: center; /* Center align block math if needed */
        }
    </style>
</head>
<body>
    <header>
        <!-- <h1>{{ page.title }}</h1> -->
    </header>
    <main>
        <div id="loading-message" class="loading-message">
            <img src="/images/loading.gif" alt="Loading" class="loading-logo" />
            <p>Preparing Interview Corner...</p>
        </div>
        <a href="javascript:history.back()" class="back-button">‚Üê Back</a>
        <div id="markdown-content" class="markdown-content">
            <!-- Content will be dynamically loaded here -->
        </div>
    </main>

    <!-- Load Markdown Content with MathJax Rendering -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const markdownUrl = "{{ page.markdown_url }}";
            const imageBaseUrl = "{{ page.img_url }}";

            async function loadMarkdown(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error('Failed to load markdown content');
                    }
                    const markdown = await response.text();
                    let renderedContent = marked.parse(markdown);

                    // Adjust image URLs
                    renderedContent = replaceImageUrls(renderedContent, imageBaseUrl);

                    // Set HTML into the page
                    document.getElementById('markdown-content').innerHTML = renderedContent;

                    // Trigger MathJax to render LaTeX
                    if (window.MathJax) {
                        MathJax.typesetPromise().then(() => {
                            // Re-render if necessary
                            document.querySelectorAll('.mathjax-display').forEach(element => {
                                MathJax.typesetPromise([element]).catch((err) => console.error('MathJax error:', err));
                            });
                        });
                    }

                    // Hide the loading message
                    document.getElementById('loading-message').style.display = 'none';
                    document.getElementById('markdown-content').style.display = 'block';
                } catch (error) {
                    console.error('Error fetching markdown:', error);
                    document.getElementById('markdown-content').textContent = 'Error loading content. Please refresh the page again...';
                }
            }

            function replaceImageUrls(content, baseUrl) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                const images = tempDiv.querySelectorAll('img');
                images.forEach(img => {
                    const src = img.getAttribute('src');
                    if (src && !src.startsWith('http')) {
                        img.src = baseUrl + src.split('/').pop();
                    }
                });
                return tempDiv.innerHTML;
            }

            function setupInternalLinks() {
                document.querySelectorAll('#markdown-content a').forEach(anchor => {
                    anchor.addEventListener('click', function(event) {
                        event.preventDefault();
                        const href = this.getAttribute('href');
                        if (href.startsWith('#')) {
                            const targetElement = document.querySelector(href);
                            if (targetElement) {
                                targetElement.scrollIntoView({ behavior: 'smooth' });
                            }
                        }
                    });
                });
            }

            loadMarkdown(markdownUrl).then(setupInternalLinks);
        });
    </script>

    <!-- Load Marked.js for Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>
</html>
